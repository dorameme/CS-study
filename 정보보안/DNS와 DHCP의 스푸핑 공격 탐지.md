# DNS와 DHCP의 특성 비교

## 개요
네트워크 통신에서 **DNS**와 **DHCP**는 모두 응답을 기반으로 동작하는 프로토콜이다.     
그러나 이 두 프로토콜은 응답 처리 방식에서 중요한 차이를 가진다.      
DHCP는 명확히 “먼저 오는 응답을 믿는” 구조를 가지고 있으며, DNS는 상황에 따라 다르게 작동한다.      
이 차이는 **공격 난이도와 스푸핑 가능성**에 직접적인 영향을 미친다.

---

## 1. DHCP – 먼저 오는 응답을 믿는 구조

### 동작 방식
DHCP 클라이언트는 네트워크에 연결될 때 IP 주소를 자동으로 받기 위해 다음과 같이 동작한다.

1. **DHCP Discover** 패킷을 브로드캐스트로 전송한다.  
2. 여러 서버가 **DHCP Offer**를 응답하면,  
   **가장 먼저 도착한 Offer**를 선택한다.  
3. 선택한 서버에 **DHCP Request**를 전송한다.  
4. 해당 서버로부터 **DHCP Ack**를 수신하고 IP를 할당받는다.

### 공격 시나리오
```
[정상 상황]
클라이언트: "DHCP Discover 전송"
정상 서버: "DHCP Offer 전송" (0.1초 후)
→ 클라이언트가 정상 서버 선택

[공격 상황]
클라이언트: "DHCP Discover 전송"
공격자 서버: "DHCP Offer 전송" (0.05초 후)  ← 먼저 도착
정상 서버: "DHCP Offer 전송" (0.1초 후)
→ 클라이언트가 공격자 서버 선택
```

### 이유
- DHCP 표준(RFC 2131)에 따라, 클라이언트는 여러 Offer 중 임의로 선택 가능하다.  
- 실제 구현에서는 일반적으로 **가장 먼저 도착한 Offer**를 선택하도록 설계되어 있다.  
- 빠른 응답을 통한 효율적인 네트워크 연결을 위해 설계된 구조이다.

### 결과
공격자가 정식 서버보다 먼저 응답하면 **악성 DHCP 서버로 위장하여 IP·게이트웨이·DNS를 조작할 수 있다.**

---

## 2. DNS – 상황에 따라 다른 신뢰 기준

### 동작 방식

#### (1) 로컬 캐시가 존재하는 경우
```
사용자: "www.example.com 접속"
→ 로컬 DNS 캐시 확인 → 존재하면 캐시 응답 사용
→ 없으면 DNS 서버로 질의 전송
```
→ **이미 저장된 캐시를 먼저 신뢰한다.**

#### (2) 여러 응답이 동시에 도착하는 경우
```
사용자: "www.example.com 질의"
공격자: "203.0.113.1 응답" (0.05초 후)
정상 DNS: "93.184.216.34 응답" (0.1초 후)
→ 대부분의 리졸버는 첫 번째 유효한 응답을 사용
```
→ 응답 유효성(ID·포트 매칭)을 통과한 첫 번째 응답을 사용한다.

#### (3) DNSSEC이 적용된 경우
- 응답의 서명을 검증하고 유효하지 않으면 버린다.  
- **빠름보다 정확성을 우선시한다.**

---

## 3. 보안 차이

### DHCP가 취약한 이유
- 빠른 응답 우선 설계로 인해 **응답 순서 기반의 스푸핑 가능성**이 높다.  
- 공격자가 DHCP Offer를 먼저 보내면 손쉽게 네트워크 설정을 조작할 수 있다.

### DNS가 상대적으로 안전한 이유
- 트랜잭션 ID와 출발지 포트가 무작위로 생성되어 응답 위조가 어렵다.  
- DNSSEC을 통해 응답 무결성을 검증할 수 있다.  
- 응답률 제한(Response Rate Limiting)으로 대량 위조 시도를 억제한다.

---

## 4. 비교 표

| 구분 | DHCP | DNS |
|------|------|------|
| **응답 선택 기준** | 첫 번째 도착한 Offer | 첫 번째 **유효한** 응답 |
| **먼저 오는 응답 신뢰 여부** | 예 (명시적) | 상황에 따라 다름 |
| **공격 난이도** | 높음 (공격 쉬움) | 낮음 (보안기능 다수) |
| **주요 보안 대책** | DHCP Snooping, 포트 보안 | DNSSEC, ID/포트 무작위화 |
| **표준 문서** | RFC 2131 (DHCP) | RFC 5452 (DNS 보안 강화 권고) |

---

## 5. 코드 예시

### DHCP 클라이언트 의사 코드
```python
def handle_dhcp_offers(self):
    if self.offers:
        first_offer = self.offers[0]  # 첫 번째 Offer 선택
        self.send_request(first_offer.server)
```

### DNS 리졸버 의사 코드
```python
def handle_dns_responses(self):
    for response in self.responses:
        if self.validate_response(response):  # 유효성 검증
            if self.is_authoritative(response):  # 권한 확인
                return response  # 첫 번째 유효한 응답 사용
```

---

## 6. 결론

- **DHCP**는 “먼저 오는 응답을 신뢰하는 구조”로 인해 **스푸핑 공격이 쉽다.**  
  → 공격자는 정식 서버보다 빠르게 Offer를 보내면 피해자를 속일 수 있다.  

- **DNS**는 “먼저 오는 유효한 응답”을 사용하지만,  
  **트랜잭션 ID 무작위화, DNSSEC** 등 다양한 보안 메커니즘으로 인해 공격이 훨씬 어렵다.  

결과적으로, “응답 순서 기반 신뢰”라는 공통점이 있지만  
**DHCP는 응답 우선 구조**, **DNS는 검증 우선 구조**로 동작한다는 점이 핵심적인 차이이다.
